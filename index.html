<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±äº¬ä¹‹æ—…</title>
    
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* ä¿®æ”¹ CSS è®Šæ•¸ï¼šæ±äº¬éƒ½æœƒå†¬æ—¥é¢¨ (Tokyo Urban Winter) */
:root {
    /* æŠŠåŸæœ¬çš„åŒ—æµ·é“è—ï¼Œæ”¹æˆæ±äº¬éµå¡”ç´…æˆ–æ˜¯éƒ½æœƒæ·±è— */
    /* æ–¹æ¡ˆ A: æ±äº¬éµå¡”ç´… (ç†±é¬§) */
    --color-primary: #E60012; 
    --color-primary-dark: #B5000E;
    
    /* æ–¹æ¡ˆ B: å…­æœ¬æœ¨é»ç‡ˆè— (å†·è‰·ï¼Œæ¨è–¦) */
    /* --color-primary: #2563EB; */
    /* --color-primary-dark: #1E40AF; */

    --color-bg: #F3F4F6; /* æ¯”è¼ƒç¾ä»£çš„æ°´æ³¥ç°ç™½ */
    --color-text: #1F2937;
}

/* èƒŒæ™¯åœ–æ¡ˆï¼šæŠŠåœ“é»æ”¹æˆæ–¹æ ¼ (æ›´åƒå¤§æ¨“/åœ°åœ–) */
body { 
    /* ...åŸæœ‰å­—å‹è¨­å®š... */
    background-image: radial-gradient(#9CA3AF 1px, transparent 1px); /* é¡è‰²æ”¹æ·±ä¸€é» */
    background-size: 20px 20px; /* å¯†åº¦æ”¹é«˜ä¸€é» */
}

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        [v-cloak] { display: none !important; }
        
        /* æµ®å‹•å°èˆªæ¢ */
        .floating-nav {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 340px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 40;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 2px 0;
        }

        .card-rounded { border-radius: 20px; }
        
        /* Banner å‹•ç•« */
        .banner-enter-active, .banner-leave-active { transition: opacity 0.5s ease; }
        .banner-enter-from, .banner-leave-to { opacity: 0; }

        /* éå ´å‹•ç•«æ¨£å¼ */
        .slide-up-enter-active,
        .slide-up-leave-active {
            transition: all 0.3s ease-out;
        }
        .slide-up-enter-from {
            opacity: 0;
            transform: translateY(20px);
        }
        .slide-up-leave-to {
            opacity: 0;
            transform: translateY(-20px);
        }

        /* çµ±ä¸€ Header è³‡è¨Šæ¡†æ¨£å¼ */
        .info-pill {
            background-color: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 999px;
            padding: 0 14px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: #475569;
            white-space: nowrap;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        
        /* éœ‡å‹•å‹•ç•« (ç·¨è¼¯æ¨¡å¼) */
        @keyframes wiggle {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-1deg); }
            75% { transform: rotate(1deg); }
            100% { transform: rotate(0deg); }
        }
        .wiggle-mode {
            animation: wiggle 0.3s ease-in-out infinite;
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <div id="app" class="h-full flex flex-col relative" v-cloak>
        
        <header class="relative w-full h-[250px] shadow-md z-20 flex-shrink-0 bg-slate-200">
            <transition name="banner">
                <img 
                    @click="randomizeBanner"
    :key="bannerImage"
    :src="bannerImage"
    onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1548263594-a71ea65a8598?auto=format&fit=crop&q=80&w=1920';"
    alt="Header Banner" 
    class="absolute inset-0 w-full h-full object-cover object-center z-0 transition-opacity duration-500"
>
            </transition>
            
            <div class="absolute inset-0 bg-white/5 z-10 pointer-events-none"></div>

            <div class="relative z-20 px-6 py-6 flex justify-between items-start h-full pointer-events-none">
    
    <div class="pointer-events-auto">
        <h1 class="text-xs font-black text-slate-800 tracking-wider flex items-center bg-white/1 backdrop-blur-sm border border-white/30 rounded-full px-5 py-2 shadow-sm">
    <i class="fas fa-city text-orange-600 mr-3 animate-pulse"></i>
    Tokyo </h1>
        
                    <button @click="refreshAll" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/30 text-slate-700 hover:bg-white/50 transition active:scale-90 shadow-md backdrop-blur-md border border-white/20 absolute top-6 right-6">
                        <i class="fas fa-sync-alt" :class="{'animate-spin': loading}"></i>
                    </button>
                </div>
            </div>

            <div class="absolute bottom-4 left-0 w-full px-4 z-20 overflow-x-auto no-scrollbar">
                <div class="flex items-center gap-2 w-max pb-1">
                    
                    <div class="info-pill" v-if="displayWeather">
                        <div class="flex items-center">
                            <i :class="displayWeather.icon" class="mr-1.5 text-base text-[var(--color-primary)]"></i>
                            <span class="mr-2 text-slate-800">{{ displayWeather.temp }}Â°</span>
                            <span class="text-slate-300 mr-2">|</span>
                            <i class="fas fa-cloud-sun text-orange-500 mr-1.5"></i>
                            <span class="text-slate-700">{{ displayWeather.sunset }}</span>
                        </div>
                    </div>
                    <div class="info-pill text-slate-500" v-else>
                        <i class="fas fa-circle-notch fa-spin mr-1.5"></i>è¼‰å…¥ä¸­
                    </div>

                    <a href="https://weathernews.jp/onebox/tenki/tokyo/" target="_blank" class="info-pill text-sky-700 hover:text-sky-900 transition">
                        WN å¤©æ°£ <i class="fas fa-external-link-alt ml-1.5 text-[10px]"></i>
                    </a>

                    <div class="info-pill text-orange-400"> 
                        <i class="fas fa-hourglass-half mr-1.5"></i>
                        <span class="mr-0.5 text-xs">å‰©</span>
                        <span class="text-base font-black mx-0.5">{{ countdown }}</span>
                        <span class="text-xs ml-0.5">å¤©</span>
                    </div>

                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar pb-32 px-4 pt-6" ref="mainContainer">
            <transition name="slide-up" mode="out-in">
                
                <div v-if="activeTab === 'itinerary'" key="itinerary" class="flex flex-col h-full">
                    
                    <div v-if="dateKeys.length > 0"  class="relative z-30 mb-4 -mt-8">
    
    <div class="absolute top-7 left-0 w-full h-[20vh] pointer-events-none" style="clip-path: inset(0 0 -100px 0);">
        
        <div class="sticky top-0 transform -translate-y-5 bg-white/50 backdrop-blur-x1 py-2 -mx-4 px-4 transition-all duration-300 pointer-events-auto">
            <div class="flex space-x-2 overflow-x-auto no-scrollbar py-2">
                <button 
                    v-for="date in dateKeys" 
                    :key="date" 
                    @click="scrollToDay(date)" 
                    class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all border" 
                    :class="selectedDay === date ? 'bg-[var(--color-primary)] text-white border-transparent shadow-md' : 'bg-white text-slate-400 border-slate-200 hover:bg-slate-50'"
                >
                    {{ formatShortDate(date) }}
                </button>
            </div>
        </div>
        
    </div>

    <div class="w-full h-[60px]"></div>

</div>

                    <div class="pb-24" ref="itineraryContainer">
                        <div v-if="selectedDay && groupedItinerary[selectedDay]" 
     class="space-y-0 transition-opacity duration-500"
     :class="{ 'opacity-50 grayscale': new Date(selectedDay) < new Date().setHours(0,0,0,0) }">
                            <div class="flex items-center mb-6 mt-2 ml-2">
                                <div>
                                    <h2 class="text-2xl font-bold text-slate-700 tracking-wide">{{ formatDate(selectedDay) }}</h2>
                                    <div class="flex items-center mt-1">
                                        <span class="text-slate-400 text-xs font-bold bg-slate-100 px-2 py-0.5 rounded mr-2">{{ getDayOfWeek(selectedDay) }}</span>
                                        <span v-if="isFutureForecast" class="text-[10px] text-emerald-500 bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100"><i class="fas fa-clock mr-1"></i>é å ±</span>
                                                                            </div>
                                </div>
                            </div>

                            <div v-for="(item, index) in groupedItinerary[selectedDay]" :key="index" class="relative pl-2 pb-2">
                                <div v-if="index > 0 && (item.Transport || item.Duration)" class="flex items-center justify-center mb-8 ml-8 relative z-0">
                                    <div class="bg-slate-100 text-slate-600 px-6 py-3 rounded-full text-base font-bold flex items-center border-2 border-slate-200 z-10 shadow-sm">
                                        <span class="mr-3 text-2xl" v-if="item.Transport && item.Transport.includes('è»Š')">ğŸš—</span>
                                        <span class="mr-3 text-2xl" v-else-if="item.Transport && (item.Transport.includes('èµ°') || item.Transport.includes('æ­¥'))">ğŸš¶</span>
                                        <span class="mr-3 text-2xl" v-else-if="item.Transport && (item.Transport.includes('JR') || item.Transport.includes('éµ'))">ğŸšƒ</span>
                                        <span v-if="item.Transport" class="mr-1">{{ item.Transport }}</span>
                                        <span v-if="item.Duration" class="text-slate-400 border-l-2 border-slate-300 pl-3 ml-2">{{ item.Duration }}</span>
                                    </div>
                                    <div class="absolute top-[-30px] bottom-[-30px] left-1/2 w-1 bg-slate-200 -z-10 h-[calc(100%+60px)]"></div>
                                </div>

                                <div 
                                    class="bg-white card-rounded shadow-sm p-5 relative overflow-hidden transition-all mb-6 border-l-[6px]"
                                    :class="getCategoryBorderClass(item.Category)"
                                >
                                    <div class="flex items-start pl-1">
                                        <div class="flex flex-col items-center mr-5 pt-1 min-w-[45px]">
                                            <div 
                                                class="mt-1 w-8 h-8 rounded-full flex items-center justify-center border shadow-sm mb-1"
                                                :class="getCategoryIconClass(item.Category)"
                                            >
                                                <i :class="getCategoryIcon(item.Category)"></i>
                                            </div>
                                        </div>

                                        <div class="flex-1 pl-1">
                                            <div class="flex justify-between items-start mb-3">
                                                <h3 class="font-bold text-slate-800 text-lg leading-snug mr-2">{{ item.Activity }}</h3>
                                                <div v-if="item.Time" class="bg-orange-100 text-orange-600 px-3 py-1 rounded-lg font-black text-sm shadow-sm whitespace-nowrap border border-orange-200">
                                                    {{ item.Time }}
                                                </div>
                                            </div>
                                            
                                            <a v-if="item.Link" :href="item.Link" target="_blank" class="inline-flex items-center text-xs text-white mb-3 font-bold bg-[var(--color-primary)] px-3 py-1.5 rounded-full shadow-sm active:scale-95 transition hover:bg-sky-600 cursor-pointer">
                                                <i class="fas fa-map-marker-alt mr-1.5"></i>
                                                <span>{{ item.Location || 'åœ°é»å°èˆª' }}</span>
                                                <i class="fas fa-chevron-right ml-1 opacity-50 text-[10px]"></i>
                                            </a>
                                            <div v-else class="flex items-center text-xs text-slate-500 mb-3 font-bold bg-slate-100 px-3 py-1.5 rounded-full w-max">
                                                <i class="fas fa-map-marker-alt text-slate-400 mr-1.5"></i>
                                                <span>{{ item.Location || 'æœªæŒ‡å®šåœ°é»' }}</span>
                                            </div>

                                            <div v-if="item.MapCode" class="mb-3"><div class="bg-[var(--color-bg)] px-3 py-2 rounded-xl flex items-center border border-slate-100"><i class="fas fa-car-side text-[var(--color-primary)] mr-3 text-lg opacity-80"></i><div class="flex flex-col"><span class="text-[9px] text-slate-400 uppercase tracking-wider font-bold">NAVI / MAPCODE</span><span class="font-mono text-base font-bold text-slate-700 tracking-wide">{{ item.MapCode }}</span></div></div></div>
                                            <div v-if="getFoodRecommendation(item)" class="bg-yellow-50 rounded-xl p-3 mb-3 border border-yellow-100"><div class="flex items-start"><span class="text-xl mr-2">ğŸ’¡</span><div><span class="text-[10px] text-yellow-600 font-black uppercase tracking-wider block mb-0.5">é¥•å®¢æ¨è–¦</span><span class="text-sm text-slate-700 font-bold leading-relaxed">{{ getFoodRecommendation(item) }}</span></div></div></div>
                                            <div v-if="item.Note" class="bg-slate-50 rounded-xl p-3 mb-3 text-sm text-slate-600 flex items-start border border-slate-100"><span class="text-slate-400 mr-2 mt-0.5">â—</span><span class="leading-relaxed text-xs break-all" v-html="formatNote(item.Note)"></span></div>
                                            
                                            <div class="mt-4 pt-3 border-t border-slate-100">
                                                <div class="relative">
                                                    <i class="fas fa-pen absolute left-3 top-3 text-yellow-500/50 text-xs"></i>
                                                    <textarea 
                                                        v-model="memos[getItemKey(item)]"
                                                        @input="saveMemos"
                                                        class="w-full bg-yellow-50/50 border border-yellow-100 rounded-xl py-2 pl-8 pr-3 text-sm text-slate-600 focus:outline-none focus:ring-2 focus:ring-yellow-200 resize-none transition-shadow"
                                                        rows="1"
                                                        placeholder="éš¨æ‰‹è¨˜ (Memo)..."
                                                        @focus="$event.target.rows = 3"
                                                        @blur="$event.target.value === '' ? $event.target.rows = 1 : $event.target.rows = 3"
                                                    ></textarea>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div v-if="dateKeys.length === 0 && !loading" class="text-center py-20 text-slate-300"><i class="far fa-snowflake text-5xl mb-4 opacity-50"></i><p>æ²’æœ‰è¡Œç¨‹è³‡æ–™</p></div>
                    </div>
                </div>

                <div v-else-if="activeTab === 'expenses'" key="expenses" class="-mt-2">
                    <div v-if="false" class="bg-white p-5 rounded-2xl shadow-sm mb-4 border border-slate-100 mx-1 relative overflow-hidden">
                        <div class="flex justify-between items-start z-10 relative">
                            <div><p class="text-xs text-slate-400 font-bold tracking-widest mb-1">PUBLIC FUND</p><h3 class="text-lg font-black text-slate-700">å…¬æ•¸é¤˜é¡</h3></div>
                            <div class="text-right"><h2 class="text-3xl font-black tracking-tight font-mono" :class="publicFundBalance >= 0 ? 'text-sky-600' : 'text-red-500'">Â¥{{ publicFundBalance.toLocaleString() }}</h2></div>
                        </div>
                        <div class="absolute right-0 bottom-0 opacity-5 text-8xl text-sky-500 rotate-12 -mb-4 -mr-4"><i class="fas fa-coins"></i></div>
                    </div>

                    <div class="bg-gradient-to-br from-slate-700 to-slate-800 p-6 card-rounded shadow-xl mb-6 text-center text-white relative overflow-hidden mx-1">
                        <p class="text-slate-300 text-s mb-1 font-bold tracking-widest uppercase">ç¸½æ´—è²»</p>
                        <h2 class="text-5xl font-black mb-6 tracking-tight font-mono">Â¥{{ totalExpense.toLocaleString() }}</h2>
                        <div class="grid grid-cols-2 gap-2 text-white pt-4 border-t border-slate-600">
                            <div v-for="name in people" :key="name" class="flex flex-col items-center"><span class="font-bold mb-1 opacity-90 text-xs">{{ name }}</span><span class="bg-white/10 px-1 py-1.5 rounded-lg w-full text-center text-sm font-bold tracking-wide">Â¥{{ getPersonTotal(name).toLocaleString() }}</span></div>
                        </div>
                    </div>

                    <div v-if="!APPS_SCRIPT_URL" class="bg-red-50 text-red-500 p-4 rounded-2xl text-xs mb-4 flex items-center border border-red-100 mx-1"><i class="fas fa-exclamation-triangle mr-3 text-lg"></i> è«‹å¡«å…¥ Apps Script ç¶²å€</div>

                    <div class="flex gap-2 mb-6 mx-1">
                        <button @click="openEditModal()" class="flex-1 bg-[var(--color-primary)] hover:bg-[var(--color-primary-dark)] text-white font-bold py-4 rounded-2xl shadow-lg transition transform active:scale-95 flex items-center justify-center text-lg"><i class="fas fa-plus mr-2"></i> è¨˜ä¸€ç­†</button>
                        <button @click="calculateSettlement" class="w-16 bg-indigo-100 text-indigo-600 hover:bg-indigo-200 font-bold rounded-2xl shadow-sm transition flex items-center justify-center flex-col text-xs"><i class="fas fa-calculator text-xl mb-1"></i> çµç®—</button>
                    </div>

                    <div class="space-y-4 pb-24 px-1">
                        <div v-for="(exp, index) in expenses" :key="index" class="bg-white p-5 card-rounded shadow-sm flex justify-between items-center border border-slate-50">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center mr-4 font-black text-sm shrink-0" :class="isDeposit(exp) ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-500'">{{ isDeposit(exp) ? 'å…¥' : (exp.payer ? exp.payer.charAt(0) : '?') }}</div>
                                <div><h4 class="font-bold text-base line-clamp-1" :class="isDeposit(exp) ? 'text-emerald-600' : 'text-slate-800'">{{ exp.description }}</h4><p class="text-xs font-bold mt-0.5" :class="isDeposit(exp) ? 'text-emerald-400' : 'text-slate-400'">{{ exp.payer }} {{ isDeposit(exp) ? 'æ³¨å…¥' : 'å…ˆä»˜' }}</p></div>
                            </div>
                            <div class="text-right shrink-0 ml-3 min-w-[80px]">
                                <span class="block font-black text-lg" :class="isDeposit(exp) ? 'text-emerald-500' : 'text-[var(--color-primary)]'">{{ isDeposit(exp) ? '+' : '' }}Â¥{{ parseInt(exp.amount).toLocaleString() }}</span><span class="text-[10px] text-slate-300 block mt-0.5 mb-1">{{ formatShortDate(exp.date) }}</span>
                                <div class="flex justify-end gap-2 mt-2">
                                     <button v-if="exp.id" @click="openEditModal(exp)" class="text-xs text-sky-400 hover:text-sky-600 px-2 py-1 bg-sky-50 rounded-lg transition font-bold"><i class="fas fa-pen"></i></button>
                                     <button v-if="exp.id" @click="deleteExpense(exp)" :disabled="isDeleting === exp.id" class="text-xs text-red-400 hover:text-red-600 px-2 py-1 bg-red-50 rounded-lg transition font-bold"><span v-if="isDeleting === exp.id"><i class="fas fa-spinner fa-spin"></i></span><span v-else><i class="fas fa-trash"></i></span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="activeTab === 'tools'" key="tools" class="-mt-2">
                    <div class="flex p-1 bg-white rounded-xl mb-4 mx-1 border border-slate-200"><button v-for="tab in ['packing', 'shopping', 'phrase']" :key="tab" @click="toolSubTab = tab" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all" :class="toolSubTab === tab ? 'bg-[var(--color-primary)] text-white shadow-sm' : 'text-slate-400'"><span v-if="tab==='packing'">ğŸ’ è¡Œæ</span><span v-else-if="tab==='shopping'">ğŸ ä»£è³¼</span><span v-else-if="tab==='phrase'">ğŸ—£ï¸ æ—¥èª</span></button></div>
                    <div v-if="toolSubTab === 'packing'" class="pb-24"><div class="bg-white card-rounded p-5 border border-slate-50 mx-1"><h3 class="font-bold text-slate-700 mb-4 flex items-center"><i class="fas fa-suitcase-rolling mr-2 text-[var(--color-primary)]"></i> é›ªåœ‹è‡ªé§•å¿…å‚™</h3><div class="space-y-3"><div v-for="(item, idx) in packingList" :key="idx" class="flex items-center p-3 rounded-xl border transition-all" :class="item.checked ? 'bg-slate-50 border-slate-100 opacity-60' : 'bg-white border-slate-200'" @click="togglePacking(idx)"><div class="w-6 h-6 rounded-full border-2 flex items-center justify-center mr-3 transition-colors" :class="item.checked ? 'bg-emerald-400 border-emerald-400 text-white' : 'border-slate-300'"><i class="fas fa-check text-xs" v-if="item.checked"></i></div><span class="text-sm font-bold" :class="item.checked ? 'text-slate-400 line-through' : 'text-slate-700'">{{ item.text }}</span></div></div></div></div>
                    
                    <div v-else-if="toolSubTab === 'shopping'" class="pb-32 px-3">
    
    

    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(145px, 1fr)); gap: 12px;">
    
    <div class="bg-slate-50 rounded-3xl border-2 border-dashed border-slate-300 hover:border-[var(--color-primary)] hover:bg-white transition-all pt-2 px-3 pb-4 flex flex-col items-center justify-between group relative overflow-hidden" 
         style="aspect-ratio: 1 / 1;">
        
        <div class="w-full text-center">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-wider mb-0.5 block">Add New</label>
            
            <input v-model="newShopItem.text" 
                   @keyup.enter="addShopItem"
                   type="text" 
                   placeholder="è¼¸å…¥å•†å“..." 
                   class="w-full bg-transparent text-center font-black text-slate-700 placeholder:text-slate-300 focus:outline-none border-b border-transparent focus:border-[var(--color-primary)] transition-all pb-1 mb-0.5 text-sm">
            
            <input v-model="newShopItem.who" 
                   @keyup.enter="addShopItem"
                   type="text" 
                   placeholder="çµ¦èª°?" 
                   class="w-full bg-transparent text-center text-xs font-bold text-slate-500 placeholder:text-slate-300 focus:outline-none focus:bg-white rounded px-1 py-1 transition-colors">

            <div class="relative w-full mt-1">
                <input v-model="newShopItem.image" 
                       type="text" 
                       readonly
                       placeholder="é»å³é‚Šç›¸æ©ŸåŠ åœ– ğŸ‘‰" 
                       class="w-full bg-transparent text-center text-[10px] text-slate-400 placeholder:text-slate-300 focus:outline-none focus:bg-white rounded px-1 py-1 transition-colors pr-8">
                
                <label class="absolute right-1 top-0.5 text-slate-400 hover:text-[var(--color-primary)] cursor-pointer p-1 active:scale-90 transition-transform bg-slate-50 rounded-full">
                    <i class="fas fa-camera text-lg"></i>
                    <input type="file" accept="image/*" class="hidden" @change="handleLocalImage">
                </label>
            </div>
        </div>

        <button @click="addShopItem" 
                class="w-12 h-12 -mb-1 rounded-full bg-[var(--color-primary)] text-white  flex items-center justify-center active:scale-90 transition-transform group-hover:scale-110">
            <i class="fas fa-plus text-xl"></i>
        </button>
    </div>

    <div v-for="(item, idx) in shoppingList" :key="idx" 
     @click="toggleShop(idx)"
     class="relative rounded-3xl border transition-all duration-300 shadow-sm active:scale-95 cursor-pointer overflow-hidden group"
     :class="[
        item.checked ? 'border-emerald-300 ring-2 ring-emerald-100' : 'border-slate-100 hover:border-[var(--color-primary)]',
        item.image ? 'bg-slate-800' : 'bg-white' 
     ]"
     style="aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 12px; text-align: center;">
    
    <div v-if="item.image" class="absolute inset-0 z-0">
        <img :src="item.image" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity duration-500">
        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
    </div>

    <button @click.stop="removeShopItem(idx)" 
            class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center z-20 transition-colors rounded-full backdrop-blur-sm"
            :class="item.image ? 'text-white/70 hover:text-red-400 bg-black/20' : 'text-slate-300 hover:text-red-400 bg-white/60'">
        <i class="fas fa-trash-alt text-xs"></i>
    </button>

    <div class="w-full flex flex-col items-center justify-center h-full z-10 relative">
        <span class="text-[10px] font-black px-2.5 py-1 rounded-full mb-2 max-w-full truncate shadow-sm"
              :class="item.checked ? 'bg-emerald-200 text-emerald-700' : (item.image ? 'bg-white/20 text-white backdrop-blur-md' : 'bg-slate-100 text-slate-500')">
            To: {{ item.who }}
        </span>

        <div class="font-black text-base leading-snug break-all line-clamp-3 w-full px-1"
             :class="[
                item.checked ? 'text-emerald-400 line-through opacity-80' : '',
                !item.checked && item.image ? 'text-white drop-shadow-md' : 'text-slate-700'
             ]">
            {{ item.text }}
        </div>
    </div>

    <div v-if="item.checked" class="absolute bottom-2 right-2 text-emerald-500 animate-bounce z-20">
        <i class="fas fa-check-circle text-xl drop-shadow-sm border-white rounded-full bg-white"></i>
    </div>
    <div v-else class="absolute bottom-2 right-2 z-20 opacity-50" :class="item.image ? 'text-white/50' : 'text-slate-200'">
        <i class="far fa-circle text-xs"></i>
    </div>




            <div v-if="item.checked" class="absolute bottom-2 right-2 text-emerald-500 animate-bounce">
                <i class="fas fa-check-circle text-xl drop-shadow-sm"></i>
            </div>
            <div v-else class="absolute bottom-2 right-2 text-slate-200 opacity-50">
                <i class="far fa-circle text-xs"></i>
            </div>

        </div>

    </div>

    <div v-if="shoppingList.length === 0" class="text-center text-slate-400 py-16 flex flex-col items-center opacity-60">
        <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
            <i class="fas fa-shopping-basket text-3xl text-slate-300"></i>
        </div>
        <span class="text-xs font-bold">ç›®å‰æ²’æœ‰ä»£è³¼é …ç›®</span>
        <span class="text-[10px] mt-1">åœ¨ä¸Šæ–¹è¼¸å…¥ä¸¦æ–°å¢å§ï¼</span>
    </div>

</div>
                    
                    <div v-else-if="toolSubTab === 'phrase'" class="pb-24">
                        <div class="flex justify-between items-center mb-4 mx-1">
                            <div class="flex flex-col">
                                <span class="text-xs text-slate-400 font-bold ml-1">å…± {{ phrasebook.length }} å¥å¸¸ç”¨èª</span>
                                <span v-if="isSavingPhrases" class="text-[10px] text-[var(--color-primary)] ml-1 font-bold animate-pulse"><i class="fas fa-cloud-upload-alt mr-1"></i>åŒæ­¥é›²ç«¯ä¸­...</span>
                                <span v-else class="text-[10px] text-slate-300 ml-1"><i class="fas fa-cloud mr-1"></i>é›²ç«¯å·²åŒæ­¥</span>
                            </div>
                            <div class="flex gap-2">
                                <button @click="isPhraseManageMode = !isPhraseManageMode" :disabled="isSavingPhrases" class="text-xs font-bold px-3 py-2 rounded-lg transition" :class="isPhraseManageMode ? 'bg-slate-200 text-slate-600' : 'bg-white text-slate-400 border border-slate-100'">
                                    <i class="fas" :class="isPhraseManageMode ? 'fa-check' : 'fa-cog'"></i> {{ isPhraseManageMode ? 'å®Œæˆ' : 'ç®¡ç†' }}
                                </button>
                                <button @click="openPhraseEditModal()" :disabled="isSavingPhrases" class="text-xs font-bold px-3 py-2 rounded-lg bg-[var(--color-primary)] text-white shadow-sm hover:opacity-90 transition active:scale-95">
                                    <i class="fas fa-plus"></i> æ–°å¢
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mx-1">
                            <div v-for="(phrase, idx) in phrasebook" :key="idx" 
                                class="bg-white card-rounded p-4 border border-slate-50 shadow-sm transition relative group"
                                :class="{'hover:border-[var(--color-primary)] cursor-pointer active:scale-95': !isPhraseManageMode, 'wiggle-mode': isPhraseManageMode}"
                                @click="!isPhraseManageMode && showPhraseModal(phrase)"
                            >
                                <div class="text-xs text-slate-400 mb-1 flex justify-between items-center">
                                    <span>{{ phrase.cat }}</span>
                                    <span v-if="!isPhraseManageMode" class="opacity-0 group-hover:opacity-100 text-[var(--color-primary)]"><i class="fas fa-expand-alt"></i></span>
                                </div>
                                <div class="font-black text-slate-700 text-lg mb-1 leading-snug">{{ phrase.cn }}</div>
                                <div class="text-[10px] text-[var(--color-primary)] truncate">{{ phrase.pron }}</div>

                                <div v-if="isPhraseManageMode" class="absolute inset-0 bg-white/90 backdrop-blur-[1px] rounded-[20px] flex flex-col items-center justify-center p-2 z-10 border-2 border-[var(--color-primary)]">
                                    <div class="flex gap-2 mb-2">
                                        <button @click.stop="movePhrase(idx, -1)" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 flex items-center justify-center disabled:opacity-30" :disabled="idx === 0"><i class="fas fa-chevron-left"></i></button>
                                        <button @click.stop="movePhrase(idx, 1)" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 flex items-center justify-center disabled:opacity-30" :disabled="idx === phrasebook.length - 1"><i class="fas fa-chevron-right"></i></button>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click.stop="openPhraseEditModal(idx)" class="px-3 py-1 bg-sky-50 text-sky-600 rounded-lg text-xs font-bold"><i class="fas fa-pen mr-1"></i>ç·¨è¼¯</button>
                                        <button @click.stop="removePhrase(idx)" class="px-3 py-1 bg-red-50 text-red-500 rounded-lg text-xs font-bold"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="activeTab === 'info'" key="info" class="-mt-4">
                    <div class="bg-white card-rounded shadow-sm p-6 mb-6 border border-slate-50 mt-2 mx-1 relative overflow-hidden">
                        <h3 class="font-bold text-[var(--color-primary)] mb-4 flex items-center text-lg"><i class="fas fa-coins text-yellow-400 mr-3 text-xl"></i> å¯¦æ™‚åŒ¯ç‡</h3>
                        <div class="flex items-center space-x-3 mb-3 relative z-10">
                            <div class="flex-1 bg-[var(--color-bg)] rounded-2xl p-4"><label class="block text-[10px] text-slate-400 mb-1 font-black tracking-widest">HKD</label><input 
    type="number" 
    inputmode="decimal" 
    v-model="calcHkd" 
    @input="updateFromHkd" 
    class="w-full bg-transparent border-none p-0 text-2xl font-black text-slate-700 focus:ring-0 placeholder-slate-300 font-mono" 
    placeholder="0"
></div>
                            <i class="fas fa-exchange-alt text-slate-300 text-xl"></i>
                            <div class="flex-1 bg-[var(--color-bg)] rounded-2xl p-4"><label class="block text-[10px] text-slate-400 mb-1 font-black tracking-widest">JPY</label><input 
    type="number" 
    inputmode="decimal" 
    v-model="calcJpy" 
    @input="updateFromJpy" 
    class="w-full bg-transparent border-none p-0 text-2xl font-black text-slate-700 focus:ring-0 placeholder-slate-300 font-mono" 
    placeholder="0"
></div>
                        </div>
                        <div class="text-right text-xs text-slate-400 font-bold px-1"><span v-if="exchangeRate">1 HKD â‰ˆ {{ exchangeRate.toFixed(2) }} JPY</span><span v-else><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</span></div>
                    </div>

                    <div class="bg-white card-rounded shadow-sm mb-6 overflow-hidden border border-slate-50 mx-1">
                        <div class="bg-[var(--color-primary)] px-6 py-4 flex justify-between items-center"><h3 class="text-white font-bold text-base tracking-wide"><i class="fas fa-plane-departure mr-3"></i>èˆªç­è³‡è¨Š</h3><span class="text-white/80 text-[10px] bg-white/20 px-3 py-1 rounded-full font-bold">HK Airlines</span></div>
                        <div class="p-6 space-y-8">
                            <div class="flex items-center justify-between relative"><div class="text-center w-1/3"><div class="text-3xl font-black text-slate-700">HKG</div><div class="text-xs text-white font-bold bg-slate-400 rounded-lg px-2 py-1 mt-1 inline-block">01:25</div></div><div class="text-center w-1/3 flex flex-col items-center px-2"><div class="text-[10px] text-slate-400 font-bold mb-1">CX524</div><div class="w-full flex items-center"><div class="h-[2px] bg-slate-200 w-full rounded-full"></div><i class="fas fa-plane text-slate-300 mx-2 text-sm"></i><div class="h-[2px] bg-slate-200 w-full rounded-full"></div></div><div class="text-[10px] text-slate-400 mt-1 font-bold">5h 45m</div></div><div class="text-center w-1/3"><div class="text-3xl font-black text-slate-700">NRT</div><div class="text-xs text-white font-bold bg-[var(--color-primary)] rounded-lg px-2 py-1 mt-1 inline-block">06:30</div></div></div>
                            <div class="flex items-center justify-between relative"><div class="text-center w-1/3"><div class="text-3xl font-black text-slate-700">NRT</div><div class="text-xs text-white font-bold bg-[var(--color-primary)] rounded-lg px-2 py-1 mt-1 inline-block">16:45</div></div><div class="text-center w-1/3 flex flex-col items-center px-2"><div class="text-[10px] text-slate-400 font-bold mb-1">CX521</div><div class="w-full flex items-center"><div class="h-[2px] bg-slate-200 w-full rounded-full"></div><i class="fas fa-plane text-slate-300 mx-2 text-sm transform rotate-180"></i><div class="h-[2px] bg-slate-200 w-full rounded-full"></div></div><div class="text-[10px] text-slate-400 mt-1 font-bold">6h 45m</div></div><div class="text-center w-1/3"><div class="text-3xl font-black text-slate-700">HKG</div><div class="text-xs text-white font-bold bg-slate-400 rounded-lg px-2 py-1 mt-1 inline-block">21:10</div></div></div>
                        </div>
                    </div>

                    <div class="bg-red-50 card-rounded shadow-sm mb-6 border border-red-100 mx-1 p-5 relative overflow-hidden">
                        <div class="absolute -right-4 -top-4 text-red-100 text-8xl opacity-50 rotate-12"><i class="fas fa-ambulance"></i></div>
                        <h3 class="font-bold text-red-700 mb-4 flex items-center relative z-10"><i class="fas fa-exclamation-circle mr-2 animate-pulse"></i> ç·Šæ€¥æ•‘æ´ / é“è·¯æƒ…å ±</h3>
                        <div class="grid grid-cols-2 gap-2 mb-4 relative z-10">
                            <a href="tel:110" class="bg-white border border-red-200 p-3 rounded-xl flex flex-col items-center justify-center hover:bg-red-100 transition text-center"><i class="fas fa-user-shield text-xl text-red-500 mb-1"></i><span class="text-xs font-black text-red-700">è­¦å¯Ÿ 110</span></a>
                            <a href="tel:119" class="bg-white border border-red-200 p-3 rounded-xl flex flex-col items-center justify-center hover:bg-red-100 transition text-center"><i class="fas fa-ambulance text-xl text-red-500 mb-1"></i><span class="text-xs font-black text-red-700">æ•‘è­· 119</span></a>
                        </div>
                        
                    </div>

                    <div class="bg-white card-rounded shadow-sm mb-6 border border-slate-50 mx-1">
                        <div class="px-6 py-5 border-b border-slate-50 flex items-center"><div class="bg-indigo-50 p-2 rounded-lg mr-3"><i class="fas fa-bed text-indigo-500"></i></div><h3 class="font-bold text-slate-800 text-lg">ä½å®¿æ¸…å–®</h3></div>
                        <div class="divide-y divide-slate-50">
                            <div v-for="(hotel, index) in hotelList" :key="index" class="p-5 hover:bg-slate-50 transition">
                                <div class="flex justify-between items-start mb-2"><span class="bg-indigo-50 text-indigo-600 text-[10px] px-3 py-1 rounded-full font-black tracking-wide">{{ hotel.nights }}</span></div>
                                <h4 class="font-bold text-slate-700 text-base mb-4 leading-tight">{{ hotel.name }}</h4>
                                <a :href="'tel:' + hotel.phone" class="flex items-center justify-center w-full text-sm text-slate-500 bg-[var(--color-bg)] px-4 py-3 rounded-xl hover:bg-indigo-50 hover:text-indigo-600 transition font-bold border border-transparent hover:border-indigo-100"><i class="fas fa-phone-alt mr-3"></i> {{ hotel.phone }}</a>
                            </div>
                        </div>
                    </div>
                </div>

            </transition>
        </main>

        <nav class="floating-nav flex justify-between items-center py-1 px-4">
            <button @click="scrollToTop('itinerary')" class="flex-1 py-1 flex flex-col items-center transition duration-300 relative group" :class="activeTab === 'itinerary' ? 'text-[var(--color-primary)]' : 'text-slate-500'"><i class="fas fa-calendar-alt text-base mb-0.5 transition-transform group-active:scale-90"></i><span class="text-[8px] font-black">è¡Œç¨‹</span></button>
            <button @click="scrollToTop('expenses')" class="flex-1 py-1 flex flex-col items-center transition duration-300 relative group" :class="activeTab === 'expenses' ? 'text-emerald-600' : 'text-slate-500'"><i class="fas fa-wallet text-base mb-0.5 transition-transform group-active:scale-90"></i><span class="text-[8px] font-black">æ´—è²»</span></button>
            <button @click="scrollToTop('tools')" class="flex-1 py-1 flex flex-col items-center transition duration-300 relative group" :class="activeTab === 'tools' ? 'text-yellow-500' : 'text-slate-500'"><i class="fas fa-briefcase text-base mb-0.5 transition-transform group-active:scale-90"></i><span class="text-[8px] font-black">å·¥å…·</span></button>
            <button @click="scrollToTop('info')" class="flex-1 py-1 flex flex-col items-center transition duration-300 relative group" :class="activeTab === 'info' ? 'text-indigo-500' : 'text-slate-500'"><i class="fas fa-book-open text-base mb-0.5 transition-transform group-active:scale-90"></i><span class="text-[8px] font-black">è³‡è¨Š</span></button>
        </nav>

        <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm" @click.self="showExpenseModal = false">
    <div class="bg-white card-rounded w-full max-w-sm p-6 shadow-2xl transform transition-all border border-white">
        
        <h3 class="text-xl font-bold mb-6 text-slate-800 flex items-center">
            <i class="fas fa-edit mr-3 text-[var(--color-primary)]"></i>
            {{ isEditing ? 'ç·¨è¼¯æ”¯å‡º' : 'æ–°å¢æ”¯å‡º' }}
        </h3>

        <div class="space-y-5">
            <div>
                <label class="block text-xs font-black text-slate-400 mb-2 ml-1 tracking-wider uppercase">é‡‘é¡ (JPY)</label>
                <input type="number" v-model="newExpense.amount" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-3xl text-center text-slate-800 font-black focus:ring-2 focus:ring-[var(--color-primary)] transition font-mono" placeholder="0" inputmode="numeric">
            </div>

            <div>
                <label class="block text-xs font-black text-slate-400 mb-2 ml-1 tracking-wider uppercase">é …ç›®åˆ†é¡</label>
                <div class="grid grid-cols-5 gap-2">
                    <button v-for="cat in ['é£Ÿ', 'é–€ç¥¨', 'æ‰‹ä¿¡', 'è»Šè²»', 'å…¶ä»–']" 
                            :key="cat"
                            @click="setExpenseCategory(cat)"
                            class="py-2 rounded-xl text-xs font-bold transition-all border"
                            :class="tempCategory === cat ? 'bg-orange-100 text-orange-600 border-orange-200 ring-2 ring-orange-100' : 'bg-white text-slate-500 border-slate-100 hover:bg-slate-50'">
                        {{ cat }}
                    </button>
                </div>
            </div>

            <div>
                <div class="relative">
                    <input type="text" v-model="tempDetails" class="w-full bg-slate-50 border-none rounded-2xl py-3 px-4 text-sm text-slate-700 font-bold focus:ring-2 focus:ring-[var(--color-primary)] transition" placeholder="(é¸å¡«) è©³ç´°èªªæ˜...">
                </div>
            </div>

            <div>
                <label class="block text-xs font-black text-slate-400 mb-2 ml-1 tracking-wider uppercase">èª°å…ˆä»˜çš„ï¼Ÿ</label>
                <div class="flex gap-3">
                    <button v-for="person in people" 
                            :key="person" 
                            @click="newExpense.payer = person"
                            class="flex-1 py-3 rounded-xl font-bold transition-all flex items-center justify-center border-2"
                            :class="newExpense.payer === person ? 'border-[var(--color-primary)] bg-[var(--color-primary)] text-white shadow-md transform scale-[1.02]' : 'border-slate-100 bg-white text-slate-400 hover:bg-slate-50'">
                        <i class="fas fa-check-circle mr-2" v-if="newExpense.payer === person"></i>
                        <i class="far fa-circle mr-2 opacity-50" v-else></i>
                        {{ person }}
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-8 flex space-x-3">
            <button @click="showExpenseModal = false" class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-2xl font-bold hover:bg-slate-200 transition">å–æ¶ˆ</button>
            <button @click="submitExpense" :disabled="isSaving" class="flex-1 py-3 bg-[var(--color-primary)] text-white rounded-2xl font-bold hover:opacity-90 transition shadow-lg flex justify-center items-center">
                <span v-if="isSaving"><i class="fas fa-circle-notch fa-spin mr-2"></i>è™•ç†ä¸­</span>
                <span v-else>ç¢ºèªå„²å­˜</span>
            </button>
        </div>
    </div>
</div>
        
        <div v-if="showPhraseEditModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm" @click.self="showPhraseEditModal = false">
            <div class="bg-white card-rounded w-full max-w-sm p-6 shadow-2xl transform transition-all border border-white">
                <h3 class="text-lg font-bold mb-4 text-slate-800 flex items-center">
                    <i class="fas fa-comment-dots mr-2 text-[var(--color-primary)]"></i>
                    {{ editingPhraseIndex !== null ? 'ç·¨è¼¯å¸¸ç”¨èª' : 'æ–°å¢å¸¸ç”¨èª' }}
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ä¸­æ–‡æ„æ€</label>
                        <input v-model="newPhrase.cn" class="w-full bg-[var(--color-bg)] border-none rounded-xl p-3 text-sm text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-primary)]" placeholder="ä¾‹å¦‚ï¼šè«‹å•å»æ‰€åœ¨å“ªï¼Ÿ">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">æ—¥æ–‡ (Kanji/Kana)</label>
                        <textarea v-model="newPhrase.jp" rows="2" class="w-full bg-[var(--color-bg)] border-none rounded-xl p-3 text-sm text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-primary)]" placeholder="ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ç™¼éŸ³ (Romaji) - é¸å¡«</label>
                        <input v-model="newPhrase.pron" class="w-full bg-[var(--color-bg)] border-none rounded-xl p-3 text-sm text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-primary)]" placeholder="Toire wa doko desu ka">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">åˆ†é¡æ¨™ç±¤</label>
                        <select v-model="newPhrase.cat" class="w-full bg-[var(--color-bg)] border-none rounded-xl p-3 text-sm text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-primary)]">
                            <option value="è‡ªé§•">è‡ªé§•</option>
                            <option value="é¤å»³">é¤å»³</option>
                            <option value="è³¼ç‰©">è³¼ç‰©</option>
                            <option value="ä½å®¿">ä½å®¿</option>
                            <option value="æ±‚åŠ©">æ±‚åŠ©</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex space-x-3">
                    <button @click="showPhraseEditModal = false" class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200 transition text-sm">å–æ¶ˆ</button>
                    <button @click="submitPhrase" :disabled="isSavingPhrases" class="flex-1 py-3 bg-[var(--color-primary)] text-white rounded-xl font-bold hover:opacity-90 transition shadow-lg text-sm flex items-center justify-center">
                         <span v-if="isSavingPhrases"><i class="fas fa-circle-notch fa-spin mr-2"></i></span>
                         <span v-else>å„²å­˜ä¸¦åŒæ­¥</span>
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showSettlementModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm" @click.self="showSettlementModal = false">
            <div class="bg-white card-rounded w-full max-w-sm p-6 shadow-2xl transform transition-all border border-white max-h-[80vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4 text-slate-800 flex items-center"><i class="fas fa-calculator mr-3 text-[var(--color-primary)]"></i>çµç®—å»ºè­°</h3>
                <div class="bg-slate-50 rounded-xl p-4 mb-4">
                    <div class="text-xs text-slate-400 font-bold mb-1">ç¸½æ”¯å‡º / å¹³å‡æ¯äºº</div>
                    <div class="flex justify-between items-end">
                        <span class="text-2xl font-black text-[var(--color-primary)]">Â¥{{ settlementTotal.toLocaleString() }}</span>
                        <span class="text-sm font-bold text-slate-600">Â¥{{ Math.ceil(settlementTotal / (people.length - 1)).toLocaleString() }} <span class="text-[10px] font-normal">/äºº</span></span>
                    </div>
                    <div class="text-[10px] text-slate-400 mt-1 text-right">*å·²æ’é™¤å…¬æ•¸èˆ‡å…¥é‡‘</div>
                </div>
                <div v-if="settlementPlan.length > 0" class="space-y-3">
                    <div v-for="(plan, idx) in settlementPlan" :key="idx" class="flex items-center justify-between bg-white border border-slate-100 p-3 rounded-xl shadow-sm">
                        <div class="flex items-center"><span class="font-bold text-slate-700">{{ plan.from }}</span><i class="fas fa-long-arrow-alt-right mx-2 text-slate-300"></i><span class="font-bold text-[var(--color-primary)]">{{ plan.to }}</span></div>
                        <span class="font-mono font-bold text-emerald-500">Â¥{{ plan.amount.toLocaleString() }}</span>
                    </div>
                </div>
                <div v-else class="text-center py-8 text-slate-400 text-sm">ç›®å‰æ”¶æ”¯å¹³è¡¡ ğŸ‰</div>
                <button @click="showSettlementModal = false" class="w-full mt-6 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200 transition">é—œé–‰</button>
            </div>
        </div>

        <div v-if="selectedPhrase" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/80 backdrop-blur-sm" @click="selectedPhrase = null">
            <div class="bg-white card-rounded w-full max-w-sm p-8 text-center shadow-2xl relative" @click.stop>
                <div class="text-xs text-[var(--color-primary)] font-bold mb-2 uppercase tracking-widest">{{ selectedPhrase.cat }}</div>
                <div class="text-4xl font-black text-slate-800 mb-4 leading-normal">{{ selectedPhrase.jp }}</div>
                <div class="text-base text-slate-500 mb-6 font-mono">{{ selectedPhrase.pron }}</div>
                <div class="text-lg font-bold text-[var(--color-primary)] bg-[var(--color-bg)] py-3 px-4 rounded-xl inline-block">{{ selectedPhrase.cn }}</div>
                <div class="mt-8 text-xs text-slate-300">é»æ“ŠèƒŒæ™¯é—œé–‰</div>
            </div>
        </div>

    </div>

    <script>
        if (typeof Vue === 'undefined') { alert('Vue.js è¼‰å…¥å¤±æ•—'); }
        if (typeof Papa === 'undefined') { alert('PapaParse è¼‰å…¥å¤±æ•—'); }

        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // ====== è™•ç†ç›¸æ©Ÿåœ–ç‰‡ (è‡ªå‹•å£“ç¸®) ======
const handleLocalImage = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    try {
        // å£“ç¸®åˆ°å¯¬åº¦ 600px (æ‰‹æ©Ÿçœ‹å¾ˆå¤ äº†)ï¼Œå“è³ª 0.6
        // é€™æ¨£æª”æ¡ˆæœƒå¾ˆå°ï¼Œä¸æœƒçˆ†æ‰ä½ çš„å„²å­˜ç©ºé–“
        const compressedBase64 = await compressImage(file, 600, 0.6);
        newShopItem.value.image = compressedBase64;
    } catch (e) {
        console.error(e);
        alert('åœ–ç‰‡è®€å–å¤±æ•—');
    } finally {
        event.target.value = ''; // æ¸…ç©ºé¸æ“‡å™¨ï¼Œè®“ä½ å¯ä»¥é‡è¤‡é¸åŒä¸€å¼µ
    }
};
const dailyBannerCounts = [6, 7, 6, 6]; 

const randomizeBanner = () => {
    const dayIndex = dateKeys.value ? dateKeys.value.indexOf(selectedDay.value) : -1;
   const maxCount = (dayIndex !== -1 && dailyBannerCounts[dayIndex]) 
                     ? dailyBannerCounts[dayIndex] 
                     : 5; 
    bannerVariant.value = Math.floor(Math.random() * maxCount) + 1;
};
// ====== å£“ç¸®å·¥å…· (é­”æ³•å’’èªï¼Œä¸ç”¨æ”¹) ======
const compressImage = (file, maxWidth, quality) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                    height = Math.round(height * (maxWidth / width));
                    width = maxWidth;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', quality));
            };
        };
        reader.onerror = error => reject(error);
    });
};
                const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQy23XunLSixMWT-i59kmc84PAS0odouNjfeBeDWHqro3dIwWt3S4D72OQK4hX9sDOXog_It7c50FF-/pub?gid=0&single=true&output=csv'; 
                const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwlVmi_KhAmeu4DLO8_vkcZQgFtnMPGMF3DksXX8t7Tkgf8oQD8Q0KXhFzCdYRCkcx6mw/exec'; 
                const people = ['IVAN', 'Hailey'];

                const hotelList = [
                    { name: 'NASPA æ–°å¤§è°·é£¯åº— ', nights: 'ç¬¬ 1-2 æ™š', phone: '+81 25-780-6111' },
                    { name: 'Kazusayaé…’åº—', nights: 'ç¬¬ 3 æ™š', phone: '+81 3-3241-1045' },
                ];

                // Food Recommendations
                const foodRecommendations = {     'æ•˜æ•˜è‹‘': 'å¿…é»ï¼šç‰›èˆŒã€æ©«è†ˆè†œã€åˆé–“å¥—é¤(CPå€¼é«˜)',     'Afuri': 'å¿…é»ï¼šæŸšå­é¹½æ‹‰éºµã€ç‚™ç‡’å‰ç‡’é£¯',     'å…­å˜èˆ': 'å¿…é»ï¼šç‰¹è£½æ²¾éºµ (è¨˜å¾—åŠ æ¹¯å‰²)',     'æ–‡å­—ç‡’': 'å¿…é»ï¼šæ˜å¤ªå­éº»ç³¬èµ·å¸æ–‡å­—ç‡’',     'Harbs': 'å¿…é»ï¼šæ°´æœåƒå±¤è›‹ç³•', 
    'ç‚¸ç‰›æ’': 'å¿…é»ï¼šç‰›ã‹ã¤ã‚‚ã¨æ‘ (åŠç†Ÿç‚¸ç‰›æ’)',     'å£½å¸': 'æ¨è–¦ï¼šæ¢…ä¸˜å£½å¸ä¹‹ç¾ç™»åˆ©ã€æ ¹å®¤èŠ±ä¸¸(æ±äº¬ä¹Ÿæœ‰åº—)',     'å±…é…’å±‹': 'å¿…é»ï¼šä¸²ç‡’æ‹¼ç›¤ã€Highball',    'è—ç“¶': 'å¿…é»ï¼šæ‹¿éµã€åˆ—æ—¥é¬†é¤…',
    'ç„¡æ•µå®¶': 'å¿…é»ï¼šæœ¬ä¸¸éºµ (è¶…æ¿ƒéƒè±šéª¨)'};
                const packingItems = [ {text: 'è­·ç…§ + å½±æœ¬', checked: false}, {text: 'åœ‹éš›é§•ç…§ + å°ç£é§•ç…§/æ—¥æ–‡è­¯æœ¬', checked: false}, {text: 'VJW æˆªåœ– (å…¥å¢ƒ/æµ·é—œ)', checked: false}, {text: 'ç¾é‡‘ (æ—¥å¹£) + ä¿¡ç”¨å¡ (JCBä½³)', checked: false}, {text: 'Simå¡ / æ¼«éŠé–‹é€š', checked: false}, {text: 'è¡Œå‹•é›»æº + å……é›»ç·š', checked: false}, {text: 'é›ªé´ (é˜²æ»‘é˜²æ°´)', checked: false}, {text: 'ç™¼ç†±è¡£ / ç™¼ç†±è¤²', checked: false}, {text: 'æ‰‹å¥— (é˜²æ°´) + æ¯›å¸½', checked: false}, {text: 'å¢¨é¡ (é›ªåœ°åå…‰å¼·)', checked: false}, {text: 'å€‹äººå¸¸å‚™è—¥ / æšˆè»Šè—¥', checked: false}, {text: 'ä¿æ¿•ä¹³æ¶² / è­·å”‡è†', checked: false}, {text: 'æš–æš–åŒ… (è²¼å¼/æ‰‹æ¡)', checked: false}, {text: 'ç‰™åˆ·ç‰™è† (éƒ¨åˆ†é£¯åº—ä¸ä¸»å‹•æä¾›)', checked: false} ];
                
                // Default Phrase Data (Fallback)
                const defaultPhrases = [ {cat: 'é¤å»³', jp: 'è‹±èªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã™ã‹', pron: 'Eigo no menyu wa arimasuka', cn: 'æœ‰è‹±æ–‡èœå–®å—ï¼Ÿ'}, {cat: 'é¤å»³', jp: 'ä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™', pron: 'Kaikei o onegaishimasu', cn: 'æˆ‘è¦çµå¸³'}, {cat: 'é¤å»³', jp: 'ãŠã™ã™ã‚ã¯ä½•ã§ã™ã‹', pron: 'Osusume wa nan desu ka', cn: 'æœ‰ä»€éº¼æ¨è–¦çš„å—ï¼Ÿ'}, {cat: 'è‡ªé§•', jp: 'æº€ã‚¿ãƒ³ã€ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ã§', pron: 'Mantan, Regyura de', cn: 'åŠ æ»¿æ²¹ (Regular)'}, {cat: 'è‡ªé§•', jp: 'é§è»Šå ´ã¯ã©ã“ã§ã™ã‹', pron: 'Chushajo wa doko desu ka', cn: 'åœè»Šå ´åœ¨å“ªè£¡ï¼Ÿ'}, {cat: 'æ±‚åŠ©', jp: 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹', pron: 'Toire wa doko desu ka', cn: 'å»æ‰€åœ¨å“ªè£¡ï¼Ÿ'}, {cat: 'æ±‚åŠ©', jp: 'ã™ã¿ã¾ã›ã‚“', pron: 'Sumimasen', cn: 'ä¸å¥½æ„æ€ / è«‹å•'} ];
                const activeTab = ref('itinerary');
                const bannerVariant = ref(1); 
                const toolSubTab = ref('packing');
                const loading = ref(false);
                const syncingExpenses = ref(false);
                const isSaving = ref(false);
                const isDeleting = ref(null);
                const isEditing = ref(false);
                const editingId = ref(null);
                const itineraryData = ref([]);
                const weather = ref(null);
                const dailyForecast = ref({});
                const usingMockData = ref(false);
                
                // Expense & Settlement Logic
                const showExpenseModal = ref(false);
                const showSettlementModal = ref(false);
                const settlementPlan = ref([]);
                const settlementTotal = ref(0);
                const expenses = ref([]);
                const newExpense = ref({ amount: '', description: '', payer: 'å…¬æ•¸' });
                const expenseMode = ref('expense');
                const tempCategory = ref('é£Ÿ'); // é è¨­åˆ†é¡
                const tempDetails = ref('');    // é è¨­è©³æƒ…
                const setExpenseCategory = (cat) => {tempCategory.value = cat;};

                // Phrasebook Logic (New with Cloud Sync)
                const phrasebook = ref(JSON.parse(localStorage.getItem('tokyo_phrases')) || defaultPhrases);
                const selectedPhrase = ref(null);
                const isPhraseManageMode = ref(false);
                const showPhraseEditModal = ref(false);
                const editingPhraseIndex = ref(null);
                const newPhrase = ref({ cat: 'å…¶ä»–', jp: '', pron: '', cn: '' });
                const isSavingPhrases = ref(false);

                // Modified: Save Phrases with explicit ACTION
                const savePhrases = async () => { 
                    localStorage.setItem('tokyo_phrases', JSON.stringify(phrasebook.value)); 
                    
                    if (!APPS_SCRIPT_URL) return;
                    isSavingPhrases.value = true;
                    
                    const phraseData = { 
                        action: 'update_phrases', // Explicit Action
                        data: phrasebook.value
                    };

                    try {
                        await fetch(APPS_SCRIPT_URL, { 
                            method: 'POST', 
                            mode: 'no-cors', 
                            headers: { 'Content-Type': 'text/plain' }, 
                            body: JSON.stringify(phraseData) 
                        });
                        console.log('Phrases synced to cloud');
                    } catch (e) {
                        console.error('Phrase sync failed', e);
                    } finally {
                        isSavingPhrases.value = false;
                    }
                };
                
                const openPhraseEditModal = (idx = null) => {
                    if (idx !== null) {
                        editingPhraseIndex.value = idx;
                        newPhrase.value = { ...phrasebook.value[idx] };
                    } else {
                        editingPhraseIndex.value = null;
                        newPhrase.value = { cat: 'å…¶ä»–', jp: '', pron: '', cn: '' };
                    }
                    showPhraseEditModal.value = true;
                };

                const submitPhrase = async () => {
                    if (!newPhrase.value.cn || !newPhrase.value.jp) { alert('è«‹è‡³å°‘è¼¸å…¥ä¸­æ–‡å’Œæ—¥æ–‡'); return; }
                    if (editingPhraseIndex.value !== null) {
                        phrasebook.value[editingPhraseIndex.value] = { ...newPhrase.value };
                    } else {
                        phrasebook.value.unshift({ ...newPhrase.value });
                    }
                    await savePhrases(); // Trigger Sync
                    showPhraseEditModal.value = false;
                };

                const removePhrase = async (idx) => {
                    if (confirm('ç¢ºå®šåˆªé™¤é€™å¥æ—¥èªå—ï¼Ÿ')) {
                        phrasebook.value.splice(idx, 1);
                        await savePhrases(); // Trigger Sync
                    }
                };

                const movePhrase = async (idx, direction) => {
                    const newIdx = idx + direction;
                    if (newIdx >= 0 && newIdx < phrasebook.value.length) {
                        const temp = phrasebook.value[idx];
                        phrasebook.value[idx] = phrasebook.value[newIdx];
                        phrasebook.value[newIdx] = temp;
                        await savePhrases(); // Trigger Sync
                    }
                };

                const selectedDay = ref(null);
                const exchangeRate = ref(null);
                const calcHkd = ref('');
                const calcJpy = ref('');
                const itineraryContainer = ref(null);
                const mainContainer = ref(null);
                
                const memos = ref(JSON.parse(localStorage.getItem('tokyo_memos')) || {});
                const packingList = ref(JSON.parse(localStorage.getItem('tokyo_packing')) || packingItems);
                const shoppingList = ref(JSON.parse(localStorage.getItem('tokyo_shopping')) || []);
                const newShopItem = ref({text: '', who: '', image: ''});
                const carInfo = ref(JSON.parse(localStorage.getItem('tokyo_car')) || { plate: '', floor: '', zone: '', note: '', imageUrl: '' });

                // Methods
                const saveCarInfo = () => { localStorage.setItem('tokyo_car', JSON.stringify(carInfo.value)); };
                
                const syncParking = async () => {
                    if (!APPS_SCRIPT_URL) { alert("è«‹å…ˆè¨­å®š Apps Script"); return; }
                    isSaving.value = true;
                    
                    saveCarInfo();

                    const parkingData = { 
                        action: 'update_parking', // Explicit Action
                        data: carInfo.value
                    };
                    
                    try { 
                        await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(parkingData) }); 
                        alert('åœè»Šè³‡è¨Šå·²åŒæ­¥ï¼'); 
                    } catch (e) { 
                        alert("åŒæ­¥å¤±æ•—"); 
                    } finally { 
                        isSaving.value = false; 
                    }
                };
                
                const convertDriveLink = (url) => {
                    if (!url) return '';
                    if (url.includes('drive.google.com/uc?export=view')) return url;
                    const match = url.match(/\/d\/(.*?)\//);
                    if (match && match[1]) {
                        return `https://drive.google.com/uc?export=view&id=${match[1]}`;
                    }
                    return url;
                };

                const isDeposit = (exp) => exp.description && exp.description.includes('(å…¥é‡‘)');

                const switchExpenseMode = (mode) => {
                    expenseMode.value = mode;
                    if (mode === 'deposit') { newExpense.value.payer = 'IVAN'; newExpense.value.description = 'å…¬è²»å…¥é‡‘'; } else { newExpense.value.payer = 'IVAN'; newExpense.value.description = ''; }
                };

                const publicFundBalance = computed(() => {
                    let balance = 0;
                    expenses.value.forEach(exp => {
                        const amount = parseInt(exp.amount) || 0;
                        
                        // æƒ…æ³ 1: å…¥é‡‘ (æœ‰äººå……å€¼åˆ°å…¬æ•¸æ± ) -> é¤˜é¡å¢åŠ 
                        // åˆ¤æ–·ä¾æ“š: æè¿°åŒ…å« "(å…¥é‡‘)" æˆ–æ˜¯ payer é›–ç„¶æ˜¯å€‹äººä½† action æ˜¯ deposit (è¦–ä½ çš„é‚è¼¯è€Œå®š)
                        // æ ¹æ“šä½ çš„ UIï¼Œå…¥é‡‘æ™‚æè¿°æœƒè‡ªå‹•åŠ ä¸Š "(å…¥é‡‘)"
                        if (exp.description && exp.description.includes('(å…¥é‡‘)')) {
                            balance += amount;
                        }
                        
                        // æƒ…æ³ 2: å…¬æ•¸æ”¯ä»˜ (å¾å…¬æ•¸æ± èŠ±éŒ¢) -> é¤˜é¡æ¸›å°‘
                        // åˆ¤æ–·ä¾æ“š: ä»˜æ¬¾äººæ˜¯ "å…¬æ•¸"ï¼Œä¸”é€™ä¸æ˜¯ä¸€ç­†å…¥é‡‘
                        else if (exp.payer === 'å…¬æ•¸') {
                            balance -= amount;
                        }
                        
                        // æƒ…æ³ 3: å€‹äººå…ˆä»˜ (å¢ŠéŒ¢) -> é¤˜é¡ä¸è®Š (å› ç‚ºé‚„æ²’å¾å…¬æ•¸æ± æ‹¿éŒ¢é‚„ä»–)
                    });
                    return balance;
                });

                const calculateSettlement = () => {
                    const balance = {};
                    people.forEach(p => { if(p !== 'å…¬æ•¸') balance[p] = 0; });
                    let total = 0;
                    expenses.value.forEach(exp => {
                        if (exp.payer !== 'å…¬æ•¸' && exp.payer !== 'SYSTEM' && !isDeposit(exp)) {
                            const amount = parseInt(exp.amount);
                            balance[exp.payer] += amount;
                            total += amount;
                        }
                    });
                    settlementTotal.value = total;
                    const personCount = people.length;
                    const average = total / personCount;
                    const diffs = [];
                    for (const person in balance) diffs.push({ name: person, val: balance[person] - average });
                    diffs.sort((a, b) => a.val - b.val);
                    const plan = [];
                    let i = 0; let j = diffs.length - 1; 
                    while (i < j) {
                        const debtor = diffs[i];
                        const creditor = diffs[j];
                        if (Math.abs(debtor.val) < 1 && Math.abs(creditor.val) < 1) break; 
                        const amount = Math.min(Math.abs(debtor.val), creditor.val);
                        if (amount > 0) plan.push({ from: debtor.name, to: creditor.name, amount: Math.ceil(amount) });
                        debtor.val += amount;
                        creditor.val -= amount;
                        if (Math.abs(debtor.val) < 1) i++;
                        if (Math.abs(creditor.val) < 1) j--;
                    }
                    settlementPlan.value = plan;
                    showSettlementModal.value = true;
                };

                const fetchItinerary = () => {
                    loading.value = true;
                    if (!SHEET_CSV_URL) { useMockData(); return; }
                    Papa.parse(SHEET_CSV_URL, {
                        download: true, header: true, skipEmptyLines: true,
                        
complete: (results) => {
    const validData = results.data.filter(row => row.Date && row.Activity);
    if(validData.length > 0) { 
        itineraryData.value = validData; 
        usingMockData.value = false;
        Vue.nextTick(() => {
            if (dateKeys.value.length > 0) {
                selectedDay.value = dateKeys.value[0];
            }
        });
    }
    loading.value = false;
}, error: (err) => { console.error(err); loading.value = false; }
                    });
                };

                const useMockData = () => { itineraryData.value = [{ Date: '2025/12/20', Time: '', Location: 'æ–°åƒæ­²æ©Ÿå ´', Activity: 'æŠµé”ï¼', Note: 'ç¯„ä¾‹è³‡æ–™', Category: 'Transport', Link: '' }]; usingMockData.value = true; loading.value = false; selectedDay.value = '2025/12/20'; };

                const fetchExpenses = async () => {
                    if (!APPS_SCRIPT_URL) return;
                    syncingExpenses.value = true;
                    try {
                        const res = await fetch(`${APPS_SCRIPT_URL}?t=${Date.now()}`);
                        const data = await res.json();
                        
                        // 1. Process Expenses
                        if (data.expenses && Array.isArray(data.expenses)) {
                            expenses.value = data.expenses;
                        }

                        // 2. Process Phrases
                        if (data.phrases && Array.isArray(data.phrases) && data.phrases.length > 0) {
                            phrasebook.value = data.phrases;
                            localStorage.setItem('tokyo_phrases', JSON.stringify(data.phrases));
                        }

                        // 3. Process Parking
                        if (data.parking) {
                            carInfo.value = data.parking;
                            localStorage.setItem('tokyo_car', JSON.stringify(data.parking));
                        }

                    } catch (e) { console.error("Sync error", e); } finally { syncingExpenses.value = false; }
                };

                const fetchWeather = async () => {
                    try {
                        const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&current_weather=true&daily=temperature_2m_max,temperature_2m_min,sunset,weathercode&timezone=Asia%2FTokyo&forecast_days=16');
                        const data = await res.json();
                        weather.value = data;
                        if (data.daily) {
                            data.daily.time.forEach((time, index) => {
                                dailyForecast.value[time] = { temp: Math.round((data.daily.temperature_2m_max[index] + data.daily.temperature_2m_min[index]) / 2), sunset: data.daily.sunset[index].split('T')[1], code: data.daily.weathercode[index] };
                            });
                        }
                    } catch (e) { console.error(e); }
                };

                const submitExpense = async () => {
    if (!newExpense.value.amount) return;

    // çµ„åˆ Descriptionï¼š "åˆ†é¡: è©³æƒ…" æˆ– åªæœ‰ "åˆ†é¡"
    let finalDesc = tempCategory.value;
    if (tempDetails.value) {
        finalDesc = `${tempCategory.value}: ${tempDetails.value}`;
    }
    newExpense.value.description = finalDesc; // è³¦å€¼å›å»

                    if (!APPS_SCRIPT_URL) { alert("è«‹å…ˆè¨­å®š Apps Script ç¶²å€ï¼"); return; }
                    isSaving.value = true;
                                        
                    // ==========================================
                    // â˜…â˜…â˜… CRITICAL FIX: SEND ID AND ACTION â˜…â˜…â˜…
                    // ==========================================
                    let action = 'add_expense';
                    let expenseId = 'id-' + Date.now(); // Create ID for new item

                    if (isEditing.value && editingId.value) {
                        action = 'edit_expense';
                        expenseId = editingId.value; // Use existing ID for edit
                    }

                    const expenseData = { 
                        action: action, 
                        id: expenseId,
                        amount: parseInt(newExpense.value.amount), 
                        description: finalDesc, 
                        payer: newExpense.value.payer 
                    };

                    try {
                        // Optimistic Update (Update UI immediately)
                        if (isEditing.value) {
                            // Find and update local item
                            const index = expenses.value.findIndex(e => e.id === expenseId);
                            if (index !== -1) {
                                expenses.value[index] = { ...expenses.value[index], ...expenseData, date: expenses.value[index].date }; // Keep original date
                            }
                        } else {
                            // Add new item
                            expenses.value.unshift({ ...expenseData, date: new Date().toISOString() });
                        }

                        // Send to Backend
                        await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(expenseData) });
                        
                        showExpenseModal.value = false;
                        newExpense.value = { amount: '', description: '', payer: 'å…¬æ•¸' };
                        
                        // Fetch later to confirm sync
                        setTimeout(fetchExpenses, 2000);
                    } catch (e) { 
                        alert("å„²å­˜å¤±æ•—: " + e.message); 
                        // Rollback optimistic update if needed (omitted for simplicity)
                    } finally { isSaving.value = false; }
                };
                
                const addExpense = submitExpense; 

                const openEditModal = (item = null) => {
    if (item) {
        isEditing.value = true; 
        editingId.value = item.id;
        newExpense.value = { amount: parseInt(item.amount), payer: item.payer };
        
        // å˜—è©¦æ‹†è§£èˆŠçš„ description (ä¾‹å¦‚ "é£Ÿ: æ‹‰éºµ" -> Cat: é£Ÿ, Detail: æ‹‰éºµ)
        const parts = (item.description || '').split(': ');
        if (parts.length > 1 && ['é£Ÿ', 'é–€ç¥¨', 'æ‰‹ä¿¡', 'è»Šè²»', 'å…¶ä»–'].includes(parts[0])) {
            tempCategory.value = parts[0];
            tempDetails.value = parts[1];
        } else {
            tempCategory.value = 'å…¶ä»–';
            tempDetails.value = item.description || '';
        }
    } else {
        isEditing.value = false; 
        editingId.value = null;
        newExpense.value = { amount: '', payer: 'IVAN' }; // é è¨­ä»˜æ¬¾äºº
        tempCategory.value = 'é£Ÿ';
        tempDetails.value = '';
    }
    showExpenseModal.value = true;
};

                const deleteExpense = async (item) => {
                    if (!item.id) { alert("ç„¡æ³•åˆªé™¤èˆŠè³‡æ–™ (ç„¡ ID)"); return; }
                    if (!confirm(`åˆªé™¤ã€Œ${item.description}ã€ï¼Ÿ`)) return;
                    isDeleting.value = item.id;
                    
                    const deleteData = {
                        action: 'delete_expense',
                        id: item.id
                    };

                    try {
                        // Optimistic Delete
                        expenses.value = expenses.value.filter(e => e.id !== item.id);

                        await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(deleteData) });
                        setTimeout(fetchExpenses, 2000);
                    } catch (e) { alert("åˆªé™¤å¤±æ•—"); } finally { isDeleting.value = null; }
                };
                
                const togglePacking = (idx) => { packingList.value[idx].checked = !packingList.value[idx].checked; localStorage.setItem('tokyo_packing', JSON.stringify(packingList.value)); };
                const addShopItem = () => { 
    if(!newShopItem.value.text) return; 
    shoppingList.value.push({ 
        text: newShopItem.value.text, 
        who: newShopItem.value.who || 'è‡ªå·±', 
        image: newShopItem.value.image || '', // ğŸ‘ˆ å­˜åœ–ç‰‡
        checked: false 
    }); 
    localStorage.setItem('tokyo_shopping', JSON.stringify(shoppingList.value)); 
    newShopItem.value = { text: '', who: '', image: '' }; // é‡ç½®
};
                const toggleShop = (idx) => { shoppingList.value[idx].checked = !shoppingList.value[idx].checked; localStorage.setItem('tokyo_shopping', JSON.stringify(shoppingList.value)); };
                const removeShopItem = (idx) => { if(confirm('åˆªé™¤æ­¤ä»£è³¼é …ç›®ï¼Ÿ')) { shoppingList.value.splice(idx, 1); localStorage.setItem('tokyo_shopping', JSON.stringify(shoppingList.value)); } };
                
                const showPhraseModal = (phrase) => { selectedPhrase.value = phrase; };
                const getItemKey = (item) => `${item.Date}-${item.Time}-${item.Activity}`;
                const saveMemos = () => localStorage.setItem('tokyo_memos', JSON.stringify(memos.value));
                
                const scrollToTop = (tab) => {
                    activeTab.value = tab;
                    if (mainContainer.value) mainContainer.value.scrollTop = 0;
                }
                const scrollToDay = (date) => { selectedDay.value = date; if (mainContainer.value) mainContainer.value.scrollTop = 0; };
                const fetchRate = async () => { try { const res = await fetch('https://api.exchangerate-api.com/v4/latest/HKD'); const data = await res.json(); exchangeRate.value = data.rates.JPY; } catch (e) {} };
                const updateFromHkd = () => { if(!exchangeRate.value) return; calcJpy.value = (parseFloat(calcHkd.value) * exchangeRate.value).toFixed(0); };
                const updateFromJpy = () => { if(!exchangeRate.value) return; calcHkd.value = (parseFloat(calcJpy.value) / exchangeRate.value).toFixed(1); };
                
                const refreshAll = () => { fetchItinerary(); fetchExpenses(); fetchWeather(); fetchRate(); };

                const bannerImage = computed(() => {
    if (dateKeys.value.length === 0 || !selectedDay.value) return '1d1.jpg';
    const dayIndex = dateKeys.value.indexOf(selectedDay.value) + 1;
    return `${bannerVariant.value}d${dayIndex}.jpg`;
});
                const countdown = computed(() => {
                    const today = new Date();
                    const tripStart = new Date('2026-01-15');
                    const diffTime = tripStart - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    return diffDays > 0 ? diffDays : 0;
                });
                
                const getWeatherIcon = (code) => {
                    if (code === 0) return 'fas fa-sun text-orange-400';
                    if (code >= 1 && code <= 3) return 'fas fa-cloud-sun text-yellow-500';
                    if (code >= 51 && code <= 67) return 'fas fa-cloud-rain text-blue-400';
                    if (code >= 71 && code <= 77) return 'fas fa-snowflake text-cyan-300';
                    if (code >= 80 && code <= 82) return 'fas fa-cloud-showers-heavy text-blue-600';
                    if (code >= 85 && code <= 86) return 'far fa-snowflake text-white';
                    return 'fas fa-cloud text-gray-400';
                };

                const displayWeather = computed(() => {
                    if (!weather.value) return null;
                    const targetDate = selectedDay.value ? selectedDay.value.replace(/\//g, '-') : null;
                    if (targetDate && dailyForecast.value[targetDate]) {
                        const f = dailyForecast.value[targetDate];
                        return { temp: f.temp, sunset: f.sunset, icon: getWeatherIcon(f.code), isForecast: true };
                    }
                    return {
                        temp: weather.value.current_weather.temperature,
                        sunset: dailyForecast.value[Object.keys(dailyForecast.value)[0]]?.sunset || '--:--',
                        icon: getWeatherIcon(weather.value.current_weather.weathercode),
                        isForecast: false
                    };
                });
                
                const isFutureForecast = computed(() => displayWeather.value?.isForecast);
                const sunsetTime = computed(() => displayWeather.value ? displayWeather.value.sunset : '--:--');

                // æœå°‹ const groupedItinerary = computed(() => { ... });
// å°‡å…¶æ•´æ®µæ›¿æ›ç‚ºï¼š

const groupedItinerary = computed(() => {
    const groups = {};
    
    // 1. å…ˆæŠŠè³‡æ–™åˆ†çµ„ (é€™éƒ¨åˆ†è·ŸåŸæœ¬ä¸€æ¨£)
    itineraryData.value.forEach(item => {
        const dateKey = item.Date.trim();
        if (!groups[dateKey]) groups[dateKey] = [];
        groups[dateKey].push(item);
    });

    // 2. è¨­å®šã€Œä»Šå¤©ã€çš„æ¨™æº– (æŠŠæ™‚é–“æ­¸é›¶ï¼Œåªæ¯”æ—¥æœŸ)
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // 3. ç‰¹æ®Šæ’åºé‚è¼¯
    const sortedKeys = Object.keys(groups).sort((a, b) => {
        const dateA = new Date(a);
        const dateB = new Date(b);
        
        // åˆ¤æ–· A å’Œ B æ˜¯å¦ç‚ºã€Œéå»ã€
        const isPastA = dateA < today;
        const isPastB = dateB < today;

        // é‚è¼¯æ ¸å¿ƒï¼š
        // å¦‚æœ A æ˜¯éå»ï¼ŒB æ˜¯æœªä¾† -> æŠŠ A ä¸Ÿåˆ°å¾Œé¢ (return 1)
        if (isPastA && !isPastB) return 1;
        
        // å¦‚æœ A æ˜¯æœªä¾†ï¼ŒB æ˜¯éå» -> æŠŠ A æ”¾åˆ°å‰é¢ (return -1)
        if (!isPastA && isPastB) return -1;
        
        // å¦‚æœå…©å€‹ç‹€æ…‹ä¸€æ¨£ (éƒ½æ˜¯éå»ï¼Œæˆ–éƒ½æ˜¯æœªä¾†) -> ç…§æ­£å¸¸æ—¥æœŸé †åºæ’
        return dateA - dateB;
    });

    // 4. é‡æ–°çµ„è£ç‰©ä»¶
    return sortedKeys.reduce((acc, date) => { 
        acc[date] = groups[date]; 
        return acc; 
    }, {});
});
                const dateKeys = computed(() => Object.keys(groupedItinerary.value));
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (parseInt(item.amount)||0), 0));
                const getPersonTotal = (name) => { return expenses.value.filter(e => e.payer === name).reduce((sum, e) => sum + (parseInt(e.amount)||0), 0); };
                
                const getCategoryBorderClass = (cat) => {
                    if (!cat) return 'border-l-slate-300';
                    const c = cat.toLowerCase();
                    if (c.includes('food') || c.includes('é£Ÿ')) return 'border-l-orange-400';
                    if (c.includes('transport') || c.includes('è¡Œ') || c.includes('è»Š')) return 'border-l-blue-400';
                    if (c.includes('sight') || c.includes('æ™¯')) return 'border-l-emerald-400';
                    if (c.includes('shop') || c.includes('è²·')) return 'border-l-pink-400';
                    if (c.includes('attention') || c.includes('æ³¨æ„')) return 'border-l-red-500';
                    return 'border-l-[var(--color-primary)]';
                };
                const getCategoryIconClass = (cat) => {
                    if (!cat) return 'border-slate-200 text-slate-300 bg-slate-50';
                    const c = cat.toLowerCase();
                    if (c.includes('food') || c.includes('é£Ÿ')) return 'border-orange-200 text-orange-400 bg-orange-50';
                    if (c.includes('transport') || c.includes('è¡Œ') || c.includes('è»Š')) return 'border-blue-200 text-blue-400 bg-blue-50';
                    if (c.includes('sight') || c.includes('æ™¯')) return 'border-emerald-200 text-emerald-500 bg-emerald-50';
                    if (c.includes('shop') || c.includes('è²·')) return 'border-pink-200 text-pink-400 bg-pink-50';
                    if (c.includes('attention') || c.includes('æ³¨æ„')) return 'border-red-200 text-red-500 bg-red-50';
                    return 'border-[var(--color-primary)] text-[var(--color-primary)] bg-sky-50';
                };
                const getCategoryIcon = (cat) => {
                    if (!cat) return 'fas fa-circle';
                    const c = cat.toLowerCase();
                    if (c.includes('food') || c.includes('é£Ÿ')) return 'fas fa-utensils';
                    if (c.includes('transport') || c.includes('è¡Œ') || c.includes('è»Š')) return 'fas fa-train';
                    if (c.includes('sight') || c.includes('æ™¯')) return 'fas fa-camera';
                    if (c.includes('shop') || c.includes('è²·')) return 'fas fa-shopping-bag';
                    if (c.includes('attention') || c.includes('æ³¨æ„')) return 'fas fa-exclamation-triangle';
                    return 'fas fa-map-pin';
                };
                const getFoodRecommendation = (item) => {
                    const cat = (item.Category || '').toLowerCase();
                    if (!cat.includes('food') && !cat.includes('é£Ÿ')) return null;
                    const activity = (item.Activity || '').toLowerCase();
                    const location = (item.Location || '').toLowerCase();
                    const combinedText = activity + location;
                    if (combinedText.includes('æ—©é¤') || combinedText.includes('breakfast')) {
                        if (!combinedText.includes('äºŒæ¢') && !combinedText.includes('ä¸‰è§’')) return null;
                    }
                    for (const [key, recommend] of Object.entries(foodRecommendations)) {
                        if (combinedText.includes(key.toLowerCase())) { return recommend; }
                    }
                    return null;
                };
                const formatNote = (text) => {
    if (!text) return '';
    // æŠŠç¶²å€è½‰æˆè¶…é€£çµçš„æ­£è¦è¡¨é”å¼
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, '<a href="$1" target="_blank" class="text-blue-500 underline font-bold relative z-20">$1</a>');
};
                const formatDate = (dateStr) => { try { const d = new Date(dateStr); return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`; } catch (e) { return dateStr; } };
                const formatShortDate = (dateStr) => { if(!dateStr) return ''; try { const d = new Date(dateStr); return `${d.getMonth() + 1}/${d.getDate()}`; } catch (e) { return ''; } }
                const getDayOfWeek = (dateStr) => { try { return ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'][new Date(dateStr).getDay()]; } catch (e) { return ''; } };

                watch(selectedDay, () => { randomizeBanner();
    if (itineraryContainer.value) itineraryContainer.value.scrollTop = 0; 
});
                watch(activeTab, (newTab) => {
                    // å¦‚æœåˆ‡æ›åˆ°çš„æ–°é é¢æ˜¯ 'info' (è³‡è¨Šé )
                    if (newTab === 'info') {
                        calcHkd.value = ''; // æ¸…ç©ºæ¸¯å¹£
                        calcJpy.value = ''; // æ¸…ç©ºæ—¥å¹£
                    }
                });
                onMounted(() => { refreshAll(); });

                return {
                    people, activeTab, toolSubTab, loading, weather, sunsetTime, groupedItinerary, dateKeys, selectedDay, expenses,
                    totalExpense, showExpenseModal, newExpense, addExpense, deleteExpense, refreshAll, syncingExpenses, isSaving, isDeleting,
                    formatDate, formatShortDate, getDayOfWeek, getCategoryBorderClass, getCategoryIconClass, getCategoryIcon, getFoodRecommendation,
                    SHEET_CSV_URL, APPS_SCRIPT_URL, getPersonTotal, usingMockData, bannerImage, countdown,
                    exchangeRate, calcHkd, calcJpy, updateFromHkd, updateFromJpy, hotelList, itineraryContainer, mainContainer,
                    packingList, shoppingList, newShopItem, togglePacking, addShopItem, toggleShop, removeShopItem, 
                    
                    // Phrasebook Updates
                    phrasebook, selectedPhrase, showPhraseModal, isPhraseManageMode, showPhraseEditModal, 
                    editingPhraseIndex, newPhrase, openPhraseEditModal, submitPhrase, removePhrase, movePhrase, isSavingPhrases,
                    
                    memos, saveMemos, getItemKey, carInfo, saveCarInfo, showSettlementModal, settlementPlan, calculateSettlement, settlementTotal,
                    expenseMode, switchExpenseMode, isDeposit, publicFundBalance,
                    openEditModal, submitExpense, isEditing, syncParking, displayWeather, isFutureForecast, scrollToTop, scrollToDay,
                    fetchRate, updateFromHkd, updateFromJpy, convertDriveLink,handleLocalImage,bannerVariant,randomizeBanner,formatNote,tempCategory, tempDetails, setExpenseCategory,
                };
            }
        }).mount('#app');
    </script>
</body>
</html>